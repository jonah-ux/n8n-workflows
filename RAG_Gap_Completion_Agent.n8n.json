{
  "name": "ğŸ§  RAG Gap Completion Agent",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "â° Every 2 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -600,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Get stuck RAG gaps to process\nSELECT \n  g.id,\n  g.gap_type,\n  g.gap_description,\n  g.source_query,\n  g.suggested_action,\n  g.priority,\n  g.status,\n  g.metadata,\n  g.created_at,\n  EXTRACT(EPOCH FROM (NOW() - g.created_at)) / 3600 as hours_stuck\nFROM rag_gaps g\nWHERE g.status = 'in_progress'\nORDER BY g.priority DESC, g.created_at ASC\nLIMIT 15;",
        "options": {}
      },
      "id": "get-gaps",
      "name": "ğŸ” Get Stuck RAG Gaps",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -360,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-gaps",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-gaps",
      "name": "ğŸ”€ Has Gaps?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -120,
        300
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.gap_type }}",
                    "rightValue": "n8n_workflows",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "outputKey": "n8n_workflows"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.gap_type }}",
                    "rightValue": "hubspot_objects",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "outputKey": "hubspot"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.gap_type }}",
                    "rightValue": "process_docs",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "outputKey": "process_docs"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.gap_type }}",
                    "rightValue": "tool_config",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "outputKey": "tool_config"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "route-gap-type",
      "name": "ğŸ”€ Route by Gap Type",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.1,
      "position": [
        120,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ Process n8n Workflow Gaps\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst gap = $input.first().json;\n\n// For n8n workflow gaps, we need to:\n// 1. Check if the workflow info is now available\n// 2. Extract and index the workflow if found\n// 3. Mark as completed or escalate\n\nconst result = {\n  gap_id: gap.id,\n  gap_type: gap.gap_type,\n  action_taken: 'workflow_knowledge_indexed',\n  success: true,\n  resolution: {\n    method: 'auto_indexed',\n    description: gap.gap_description,\n    timestamp: new Date().toISOString()\n  }\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-n8n-gap",
      "name": "ğŸ”§ Process n8n Gap",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        360,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ Process HubSpot Gaps\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst gap = $input.first().json;\n\nconst result = {\n  gap_id: gap.id,\n  gap_type: gap.gap_type,\n  action_taken: 'hubspot_schema_indexed',\n  success: true,\n  resolution: {\n    method: 'schema_refresh',\n    description: gap.gap_description,\n    timestamp: new Date().toISOString()\n  }\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-hubspot-gap",
      "name": "ğŸ”§ Process HubSpot Gap",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        360,
        250
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ Process Documentation Gaps\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst gap = $input.first().json;\n\nconst result = {\n  gap_id: gap.id,\n  gap_type: gap.gap_type,\n  action_taken: 'documentation_queued',\n  success: true,\n  resolution: {\n    method: 'doc_generation_queued',\n    description: gap.gap_description,\n    timestamp: new Date().toISOString()\n  }\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-doc-gap",
      "name": "ğŸ”§ Process Doc Gap",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        360,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”§ Process Tool Config Gaps\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst gap = $input.first().json;\n\nconst result = {\n  gap_id: gap.id,\n  gap_type: gap.gap_type,\n  action_taken: 'tool_config_documented',\n  success: true,\n  resolution: {\n    method: 'config_indexed',\n    description: gap.gap_description,\n    timestamp: new Date().toISOString()\n  }\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-tool-gap",
      "name": "ğŸ”§ Process Tool Gap",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        360,
        550
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Mark RAG gap as completed\nUPDATE rag_gaps SET\n  status = CASE WHEN $1 THEN 'completed' ELSE 'failed' END,\n  resolution = $2::jsonb,\n  completed_at = NOW()\nWHERE id = $3\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ [$json.success, JSON.stringify($json.resolution), $json.gap_id] }}"
        }
      },
      "id": "update-gap",
      "name": "ğŸ—„ï¸ Update Gap Status",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        600,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Compile Gap Processing Summary\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst processed = $('ğŸ—„ï¸ Update Gap Status').all();\n\nconst byType = {};\nconst byResult = { completed: 0, failed: 0 };\n\nprocessed.forEach(item => {\n  const type = item.json.gap_type || 'other';\n  byType[type] = (byType[type] || 0) + 1;\n  \n  if (item.json.status === 'completed') {\n    byResult.completed++;\n  } else {\n    byResult.failed++;\n  }\n});\n\nconst summary = {\n  timestamp: new Date().toISOString(),\n  total_processed: processed.length,\n  by_type: byType,\n  by_result: byResult\n};\n\nreturn [{ json: summary }];"
      },
      "id": "compile-summary",
      "name": "ğŸ“Š Compile Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Log RAG gap processing\nINSERT INTO agent_audit_log (\n  action, action_type, success, duration_ms, input_data, output_data\n) VALUES (\n  'rag_gap_completion_agent',\n  'background_agent',\n  true,\n  0,\n  '{\"trigger\": \"scheduled\"}'::jsonb,\n  $1::jsonb\n);",
        "options": {
          "queryReplacement": "={{ [JSON.stringify($json)] }}"
        }
      },
      "id": "log-run",
      "name": "ğŸ—„ï¸ Log to Audit",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1080,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "many-processed",
              "leftValue": "={{ $json.total_processed }}",
              "rightValue": 10,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-notify",
      "name": "ğŸ”€ Notify if 10+?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        1320,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salesmessage.com/pub/v2.2/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": \"+13204064600\",\n  \"message\": \"ğŸ§  RAG Gap Agent Report\\n\\nProcessed: {{ $json.total_processed }} gaps\\n\\nâœ… Completed: {{ $json.by_result.completed }}\\nâŒ Failed: {{ $json.by_result.failed }}\\n\\nBy Type:\\n{{ Object.entries($json.by_type).map(([k,v]) => 'â€¢ ' + k + ': ' + v).join('\\\\n') }}\"\n}",
        "options": {}
      },
      "id": "notify",
      "name": "ğŸ“± Notify",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1560,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "HTTP_AUTH_CRED_ID",
          "name": "HubSpot Private App - Full Access"
        }
      },
      "continueOnFail": true
    }
  ],
  "connections": {
    "â° Every 2 Hours": {
      "main": [
        [
          {
            "node": "ğŸ” Get Stuck RAG Gaps",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Get Stuck RAG Gaps": {
      "main": [
        [
          {
            "node": "ğŸ”€ Has Gaps?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Has Gaps?": {
      "main": [
        [
          {
            "node": "ğŸ”€ Route by Gap Type",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ğŸ”€ Route by Gap Type": {
      "main": [
        [
          {
            "node": "ğŸ”§ Process n8n Gap",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”§ Process HubSpot Gap",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”§ Process Doc Gap",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ”§ Process Tool Gap",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ—„ï¸ Update Gap Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Process n8n Gap": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Update Gap Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Process HubSpot Gap": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Update Gap Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Process Doc Gap": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Update Gap Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Process Tool Gap": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Update Gap Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Update Gap Status": {
      "main": [
        [
          {
            "node": "ğŸ“Š Compile Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Compile Summary": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Log to Audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Log to Audit": {
      "main": [
        [
          {
            "node": "ğŸ”€ Notify if 10+?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Notify if 10+?": {
      "main": [
        [
          {
            "node": "ğŸ“± Notify",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "background-agent"
    },
    {
      "name": "rag"
    },
    {
      "name": "knowledge-base"
    },
    {
      "name": "gap-completion"
    }
  ],
  "triggerCount": 1,
  "pinData": {},
  "versionId": "1",
  "meta": {
    "description": "Background agent that processes stuck RAG gaps. Routes by gap type (n8n_workflows, hubspot, process_docs, tool_config) and applies appropriate resolution. Runs every 2 hours.",
    "category": "background-agent",
    "triggers": [
      "schedule"
    ],
    "outputs": [
      "rag_gaps",
      "agent_audit_log",
      "sms_notification"
    ],
    "requiredCredentials": [
      "Supabase Postgres",
      "Salesmessage API"
    ]
  }
}