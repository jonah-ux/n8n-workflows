{
  "name": "âš™ï¸ Auto-Enrichment Background Processor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "â° Every 2 Hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -800,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Get pending research runs for processing\nSELECT \n  r.id as run_id,\n  r.company_id,\n  r.status,\n  r.context_jsonb,\n  c.business_name,\n  c.domain,\n  c.website_url,\n  c.phone,\n  c.address,\n  c.dcs_tier,\n  c.dcs_score\nFROM research_runs r\nJOIN companies c ON r.company_id = c.place_id\nWHERE r.status = 'pending'\nORDER BY \n  CASE c.dcs_tier WHEN 'platinum' THEN 1 WHEN 'gold' THEN 2 ELSE 3 END,\n  r.created_at ASC\nLIMIT 5;",
        "options": {}
      },
      "id": "get-pending-runs",
      "name": "ğŸ” Get Pending Runs",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -560,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      },
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-runs",
              "leftValue": "={{ $json.run_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-runs",
      "name": "ğŸ”€ Has Runs?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        -320,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Mark run as processing\nUPDATE research_runs SET status = 'processing' WHERE id = $1 RETURNING *;",
        "options": {
          "queryReplacement": "={{ [$json.run_id] }}"
        }
      },
      "id": "mark-processing",
      "name": "ğŸ—„ï¸ Mark Processing",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -80,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-domain",
              "leftValue": "={{ $('ğŸ” Get Pending Runs').item.json.domain }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-has-domain",
      "name": "ğŸ”€ Has Domain?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        160,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.hunter.io/v2/domain-search",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpQueryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "domain",
              "value": "={{ $('ğŸ” Get Pending Runs').item.json.domain }}"
            },
            {
              "name": "limit",
              "value": "5"
            }
          ]
        },
        "options": {}
      },
      "id": "hunter-search",
      "name": "ğŸ” Hunter.io Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "HTTP_AUTH_CRED_ID",
          "name": "HubSpot Private App - Full Access"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://serpapi.com/search.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpQueryAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $('ğŸ” Get Pending Runs').item.json.business_name + ' ' + ($('ğŸ” Get Pending Runs').item.json.address || '').split(',')[1] + ' owner contact' }}"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {}
      },
      "id": "serpapi-search",
      "name": "ğŸ” SerpAPI Research",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "HTTP_AUTH_CRED_ID",
          "name": "HubSpot Private App - Full Access"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// âš™ï¸ Process Enrichment Results\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst runData = $('ğŸ” Get Pending Runs').item.json;\nconst hunterResult = $('ğŸ” Hunter.io Search').first()?.json || {};\nconst serpResult = $('ğŸ” SerpAPI Research').first()?.json || {};\n\n// Extract Hunter data\nconst hunterData = hunterResult.data || {};\nconst emails = hunterData.emails || [];\nconst pattern = hunterData.pattern || null;\n\n// Find best email (owner/founder/manager)\nconst ownerKeywords = ['owner', 'founder', 'president', 'ceo', 'manager', 'director'];\nlet bestEmail = emails.find(e => {\n  const position = (e.position || '').toLowerCase();\n  return ownerKeywords.some(k => position.includes(k));\n}) || emails[0];\n\n// Extract SerpAPI data\nconst organicResults = serpResult.organic_results || [];\nconst knowledgeGraph = serpResult.knowledge_graph || {};\n\n// Compile enrichment data\nconst enrichmentData = {\n  hunter: {\n    domain: hunterData.domain,\n    organization: hunterData.organization,\n    emails_found: emails.length,\n    pattern: pattern,\n    best_contact: bestEmail ? {\n      email: bestEmail.value,\n      first_name: bestEmail.first_name,\n      last_name: bestEmail.last_name,\n      position: bestEmail.position,\n      confidence: bestEmail.confidence\n    } : null\n  },\n  serp: {\n    results_found: organicResults.length,\n    knowledge_graph: knowledgeGraph.title ? {\n      title: knowledgeGraph.title,\n      description: knowledgeGraph.description,\n      type: knowledgeGraph.type\n    } : null,\n    top_results: organicResults.slice(0, 3).map(r => ({\n      title: r.title,\n      link: r.link,\n      snippet: r.snippet\n    }))\n  }\n};\n\n// Calculate data quality score\nlet qualityScore = 0;\nlet dataPointsCollected = 0;\n\nif (bestEmail) {\n  qualityScore += 30;\n  dataPointsCollected += 4; // email, name, position, confidence\n}\nif (hunterData.organization) {\n  qualityScore += 10;\n  dataPointsCollected += 1;\n}\nif (knowledgeGraph.title) {\n  qualityScore += 15;\n  dataPointsCollected += 2;\n}\nif (organicResults.length > 0) {\n  qualityScore += 10;\n  dataPointsCollected += organicResults.length;\n}\n\nconst result = {\n  run_id: runData.run_id,\n  company_id: runData.company_id,\n  workflow_name: 'Auto_Enrichment_Processor',\n  data: enrichmentData,\n  data_quality_score: qualityScore / 100,\n  data_points_collected: dataPointsCollected,\n  has_errors: false,\n  completed_at: new Date().toISOString()\n};\n\nreturn [{ json: result }];"
      },
      "id": "process-results",
      "name": "âš™ï¸ Process Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        640,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Save enrichment results\nINSERT INTO enrichment_results (\n  research_run_id, company_id, workflow_name,\n  status, data, data_points_collected, has_errors, completed_at\n) VALUES (\n  $1, $2, $3,\n  'completed', $4::jsonb, $5, $6, $7\n)\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ [$json.run_id, $json.company_id, $json.workflow_name, JSON.stringify($json.data), $json.data_points_collected, $json.has_errors, $json.completed_at] }}"
        }
      },
      "id": "save-results",
      "name": "ğŸ—„ï¸ Save Enrichment",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        880,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Update company with enriched data\nUPDATE companies SET\n  dcs_score = GREATEST(dcs_score, $1 * 100),\n  dcs_tier = CASE \n    WHEN GREATEST(dcs_score, $1 * 100) >= 80 THEN 'platinum'\n    WHEN GREATEST(dcs_score, $1 * 100) >= 60 THEN 'gold'\n    ELSE 'bronze'\n  END,\n  updated_at = NOW()\nWHERE place_id = $2\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ [$('âš™ï¸ Process Results').item.json.data_quality_score, $('âš™ï¸ Process Results').item.json.company_id] }}"
        }
      },
      "id": "update-company",
      "name": "ğŸ—„ï¸ Update Company DCS",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1120,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Mark research run as completed\nUPDATE research_runs SET\n  status = 'completed',\n  context_jsonb = context_jsonb || $1::jsonb,\n  context_summary = 'Enrichment completed with ' || $2 || ' data points'\nWHERE id = $3\nRETURNING *;",
        "options": {
          "queryReplacement": "={{ [JSON.stringify({enrichment_completed: new Date().toISOString(), data_quality_score: $('âš™ï¸ Process Results').item.json.data_quality_score}), $('âš™ï¸ Process Results').item.json.data_points_collected, $('âš™ï¸ Process Results').item.json.run_id] }}"
        }
      },
      "id": "mark-completed",
      "name": "ğŸ—„ï¸ Mark Completed",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1360,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š Compile Enrichment Summary\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst completed = $('ğŸ—„ï¸ Mark Completed').all();\n\nconst summary = {\n  timestamp: new Date().toISOString(),\n  total_processed: completed.length,\n  companies: completed.map(c => ({\n    run_id: c.json.id,\n    company_id: c.json.company_id,\n    status: c.json.status\n  }))\n};\n\nreturn [{ json: summary }];"
      },
      "id": "compile-summary",
      "name": "ğŸ“Š Compile Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Log enrichment run\nINSERT INTO agent_audit_log (\n  action, action_type, success, duration_ms, output_data\n) VALUES (\n  'auto_enrichment_processor',\n  'background_agent',\n  true,\n  0,\n  $1::jsonb\n);",
        "options": {
          "queryReplacement": "={{ [JSON.stringify($json)] }}"
        }
      },
      "id": "log-run",
      "name": "ğŸ—„ï¸ Log to Audit",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1840,
        300
      ],
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CRED_ID",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "processed-many",
              "leftValue": "={{ $json.total_processed }}",
              "rightValue": 3,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-notify",
      "name": "ğŸ”€ Notify if 3+?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.1,
      "position": [
        2080,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.salesmessage.com/pub/v2.2/messages",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": \"+13204064600\",\n  \"message\": \"âš™ï¸ Auto-Enrichment Complete!\\n\\nProcessed: {{ $json.total_processed }} companies\\n\\nHunter.io + SerpAPI enrichment applied.\\nDCS scores updated.\"\n}",
        "options": {}
      },
      "id": "notify",
      "name": "ğŸ“± Notify",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2320,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "HTTP_AUTH_CRED_ID",
          "name": "HubSpot Private App - Full Access"
        }
      },
      "continueOnFail": true
    }
  ],
  "connections": {
    "â° Every 2 Hours": {
      "main": [
        [
          {
            "node": "ğŸ” Get Pending Runs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Get Pending Runs": {
      "main": [
        [
          {
            "node": "ğŸ”€ Has Runs?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Has Runs?": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Mark Processing",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ğŸ—„ï¸ Mark Processing": {
      "main": [
        [
          {
            "node": "ğŸ”€ Has Domain?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Has Domain?": {
      "main": [
        [
          {
            "node": "ğŸ” Hunter.io Search",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ğŸ” SerpAPI Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Hunter.io Search": {
      "main": [
        [
          {
            "node": "ğŸ” SerpAPI Research",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” SerpAPI Research": {
      "main": [
        [
          {
            "node": "âš™ï¸ Process Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš™ï¸ Process Results": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Save Enrichment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Save Enrichment": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Update Company DCS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Update Company DCS": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Mark Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Mark Completed": {
      "main": [
        [
          {
            "node": "ğŸ“Š Compile Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Compile Summary": {
      "main": [
        [
          {
            "node": "ğŸ—„ï¸ Log to Audit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ—„ï¸ Log to Audit": {
      "main": [
        [
          {
            "node": "ğŸ”€ Notify if 3+?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”€ Notify if 3+?": {
      "main": [
        [
          {
            "node": "ğŸ“± Notify",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "enrichment"
    },
    {
      "name": "hunter"
    },
    {
      "name": "serpapi"
    },
    {
      "name": "background-agent"
    },
    {
      "name": "dcs"
    }
  ],
  "triggerCount": 1,
  "pinData": {},
  "versionId": "1",
  "meta": {
    "description": "Background enrichment processor that takes pending research runs and enriches company data using Hunter.io and SerpAPI. Updates DCS scores and saves enrichment results. Runs every 2 hours.",
    "category": "enrichment",
    "triggers": [
      "schedule"
    ],
    "outputs": [
      "enrichment_results",
      "companies",
      "research_runs",
      "agent_audit_log"
    ],
    "requiredCredentials": [
      "Supabase Postgres",
      "Hunter.io API",
      "SerpAPI",
      "Salesmessage API"
    ]
  }
}