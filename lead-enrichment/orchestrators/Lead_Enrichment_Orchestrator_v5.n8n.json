{
  "name": "Lead Enrichment Orchestrator v5",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [-2000, 0],
      "id": "trigger-external",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-2000, 160],
      "id": "trigger-manual",
      "name": "When clicking 'Execute workflow'"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appUmr7c5VACTjiJj",
          "mode": "list",
          "cachedResultName": "ASM Lead Intelligence Hub (Copy)"
        },
        "table": {
          "__rl": true,
          "value": "tblLxOBg1zHfLYyUJ",
          "mode": "list",
          "cachedResultName": "Companies (Canonical)"
        },
        "filterByFormula": "AND({research_status}=BLANK())",
        "returnAll": false,
        "limit": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [-1776, 160],
      "id": "airtable-search",
      "name": "ğŸ” Search Airtable Records",
      "credentials": {
        "airtableTokenApi": {
          "id": "mP0iHEaWU9UB0y9B",
          "name": "Jonah's n8n Personal Access Token Confirmed"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first();\nconst j = item.json;\nconst f = (j.fields && typeof j.fields === 'object') ? j.fields : j;\n\nconst safe = (v) => (v === null || v === undefined) ? '' : String(v);\nconst normalizeDomain = (urlOrDomain) =>\n  safe(urlOrDomain).replace(/^https?:\\/\\//i, '').replace(/^www\\./i, '').split('/')[0].trim();\n\nconst hq = safe(f['HQ Address'] || f['Address'] || f['Location'] || '');\nconst parts = hq.split(',').map(s => s.trim());\n\nreturn [{\n  json: {\n    airtable_id: safe(j.id || f.id || ''),\n    company_name: safe(f['Company Name'] || f['company_name'] || f['name'] || ''),\n    location: hq,\n    city: parts[1] || '',\n    state: (parts[2] || '').split(' ')[0] || '',\n    domain: safe(f['Website'] || f['website'] || f['domain'] || ''),\n    search_domain: normalizeDomain(f['Website'] || f['website'] || f['domain'] || ''),\n    phone: safe(f['Phone'] || f['phone'] || ''),\n    address: hq,\n    timestamp: new Date().toISOString(),\n    enrichment_id: `${Date.now()}-${safe(f['Company Name'] || 'unknown').replace(/[^a-zA-Z0-9]/g, '').slice(0,20)}`,\n    research_run_id: $execution.id.toString(),\n    company_id: safe(j.id || f.id || '')\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1552, 80],
      "id": "normalize-record",
      "name": "ğŸ§± Normalize Record"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO enrichment_loop_runs (research_run_id, company_id, current_phase, status) VALUES ($1, $2, 'phase_1', 'running') ON CONFLICT DO NOTHING RETURNING id;",
        "options": {
          "queryReplacement": "={{ [$json.research_run_id, $json.company_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-1328, 80],
      "id": "register-run",
      "name": "ğŸ—„ï¸ Register Run",
      "credentials": {
        "postgres": {
          "id": "xogKD739Qe4gqWBU",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "ICy-FJLl7ZNFNQEzf3iKE",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('ğŸ§± Normalize Record').item.json.airtable_id }}",
            "company_name": "={{ $('ğŸ§± Normalize Record').item.json.company_name }}",
            "location": "={{ $('ğŸ§± Normalize Record').item.json.location }}",
            "city": "={{ $('ğŸ§± Normalize Record').item.json.city }}",
            "state": "={{ $('ğŸ§± Normalize Record').item.json.state }}",
            "domain": "={{ $('ğŸ§± Normalize Record').item.json.domain }}",
            "search_domain": "={{ $('ğŸ§± Normalize Record').item.json.search_domain }}",
            "phone": "={{ $('ğŸ§± Normalize Record').item.json.phone }}",
            "timestamp": "={{ $('ğŸ§± Normalize Record').item.json.timestamp }}",
            "enrichment_id": "={{ $('ğŸ§± Normalize Record').item.json.enrichment_id }}",
            "research_run_id": "={{ $('ğŸ§± Normalize Record').item.json.research_run_id }}",
            "company_id": "={{ $('ğŸ§± Normalize Record').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [-1104, 80],
      "id": "stage-0",
      "name": "ğŸš¦ Stage 0: Smart Entry Router",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const data = $json;\nconst input = $('ğŸ§± Normalize Record').first().json;\nconst runSummary = data.run_summary || {};\n\nconst domain = runSummary.domain || data.domain || input.search_domain || input.domain || null;\nconst hasDomain = !!domain && domain.length > 3;\n\nreturn [{\n  json: {\n    ...input,\n    resolved_domain: domain,\n    has_valid_domain: hasDomain,\n    routing_path: runSummary.routing_path || 'unknown',\n    stage_0_status: runSummary.status || 'completed'\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-880, 80],
      "id": "process-stage-0",
      "name": "âš™ï¸ Process Stage 0"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "has-domain",
              "leftValue": "={{ $json.has_valid_domain }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-656, 80],
      "id": "check-domain",
      "name": "ğŸ”€ Has Domain?"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "DVDTaG8QlJkivPVgFDx8Z",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $json.airtable_id }}",
            "company_name": "={{ $json.company_name }}",
            "location": "={{ $json.location }}",
            "city": "={{ $json.city }}",
            "state": "={{ $json.state }}",
            "domain": "={{ $json.resolved_domain }}",
            "search_domain": "={{ $json.resolved_domain }}",
            "phone": "={{ $json.phone }}",
            "timestamp": "={{ $json.timestamp }}",
            "enrichment_id": "={{ $json.enrichment_id }}",
            "research_run_id": "={{ $json.research_run_id }}",
            "company_id": "={{ $json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [-400, 0],
      "id": "stage-1",
      "name": "ğŸ”¥ Stage 1: Firecrawl Website",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HfMeQf6oCHhL9Q0p2H9ye",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [-160, -80],
      "id": "stage-2a",
      "name": "ğŸ“§ Stage 2a: Contact Form Hunter",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "4YgfhwtJDdVoBaQu",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [-160, 80],
      "id": "stage-2b",
      "name": "ğŸ“§ Stage 2b: Hunter.io",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [80, 0],
      "id": "merge-2",
      "name": "ğŸ¤ Merge Stage 2"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Hl9aGZsO2GRt4eWGIkvxs",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [320, 0],
      "id": "stage-3",
      "name": "ğŸ“Š Stage 3: Firmographics (Apollo)",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "IBw7IpH80m0TMa45KCJF5",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [560, -80],
      "id": "stage-4a",
      "name": "ğŸ‘¤ Stage 4a: Headhunter Agent",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LkcBjvdlGqBOYSdP",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [560, 80],
      "id": "stage-4b",
      "name": "ğŸ‘¤ Stage 4b: Owner Research",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [800, 0],
      "id": "merge-4",
      "name": "ğŸ¤ Merge Stage 4"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LIhNhNsPemc-merLoqThs",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1040, -160],
      "id": "stage-5a",
      "name": "ğŸ•µï¸ Stage 5a: Intel Analyst",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "8KCihPqoU_xH5QkiP8UAr",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1040, 0],
      "id": "stage-5b",
      "name": "ğŸ’¼ Stage 5b: Job Board Hunter",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "JllE0lttkSdFofbqzdibL",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1040, 160],
      "id": "stage-5c",
      "name": "ğŸ“„ Stage 5c: Career Page Analyzer",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [1280, 0],
      "id": "merge-5",
      "name": "ğŸ¤ Merge Stage 5"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "I039785tdTuohF_CqRlIB",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $('âš™ï¸ Process Stage 0').item.json.airtable_id }}",
            "company_name": "={{ $('âš™ï¸ Process Stage 0').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Process Stage 0').item.json.location }}",
            "city": "={{ $('âš™ï¸ Process Stage 0').item.json.city }}",
            "state": "={{ $('âš™ï¸ Process Stage 0').item.json.state }}",
            "domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "search_domain": "={{ $('âš™ï¸ Process Stage 0').item.json.resolved_domain }}",
            "phone": "={{ $('âš™ï¸ Process Stage 0').item.json.phone }}",
            "timestamp": "={{ $('âš™ï¸ Process Stage 0').item.json.timestamp }}",
            "enrichment_id": "={{ $('âš™ï¸ Process Stage 0').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1520, 0],
      "id": "stage-6",
      "name": "â­ Stage 6: Apify Reviews",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "A4-U5nCoP9WMSikDE3qdi",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "company_id": "={{ $('âš™ï¸ Process Stage 0').item.json.company_id }}",
            "research_run_id": "={{ $('âš™ï¸ Process Stage 0').item.json.research_run_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [1760, 0],
      "id": "stage-7",
      "name": "ğŸ§  Stage 7: Context Updater",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// PHASE 2: ASSESSMENT - Calculate confidence and identify retry candidates\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst input = $('âš™ï¸ Process Stage 0').first().json;\nconst contextUpdaterResult = $json;\n\n// Try to get context from the context updater result or build from what we have\nconst context = contextUpdaterResult.context || contextUpdaterResult.data || {};\n\n// Key fields and their weights for confidence scoring\nconst keyFields = {\n  owner_email: 0.20,\n  owner_name: 0.15,\n  phone: 0.12,\n  employee_count: 0.10,\n  domain: 0.08,\n  google_rating: 0.08,\n  owner_linkedin: 0.07,\n  revenue: 0.06,\n  services: 0.05,\n  industry: 0.05,\n  contact_emails: 0.04\n};\n\n// Calculate confidence score\nlet confidenceScore = 0;\nlet keyFieldsFound = 0;\nlet foundFields = [];\nlet missingFields = [];\n\n// Check input data as well as context\nconst checkValue = (field) => {\n  const val = context[field] || input[field];\n  return val !== undefined && val !== null && val !== '' && \n         !(Array.isArray(val) && val.length === 0);\n};\n\nfor (const [field, weight] of Object.entries(keyFields)) {\n  if (checkValue(field)) {\n    confidenceScore += weight;\n    keyFieldsFound++;\n    foundFields.push(field);\n  } else {\n    missingFields.push(field);\n  }\n}\n\n// Always count domain if we have it from Stage 0\nif (input.resolved_domain && !foundFields.includes('domain')) {\n  confidenceScore += keyFields.domain;\n  keyFieldsFound++;\n  foundFields.push('domain');\n  missingFields = missingFields.filter(f => f !== 'domain');\n}\n\n// Thresholds\nconst CONFIDENCE_THRESHOLD = 0.80;\nconst KEY_FIELDS_THRESHOLD = 3;\n\nconst meetsConfidence = confidenceScore >= CONFIDENCE_THRESHOLD;\nconst meetsKeyFields = keyFieldsFound >= KEY_FIELDS_THRESHOLD;\nconst shouldExit = meetsConfidence || meetsKeyFields;\n\n// Identify stages that could benefit from retry\nconst stagesToRetry = [];\n\n// If we have owner_name but no owner_email, retry Hunter.io\nif (checkValue('owner_name') && !checkValue('owner_email')) {\n  stagesToRetry.push({ stage: 'email_discovery', workflow_id: '4YgfhwtJDdVoBaQu', reason: 'Have owner_name, retry for owner_email' });\n}\n\n// If we have domain but no employee_count, retry Apollo\nif (checkValue('domain') && !checkValue('employee_count')) {\n  stagesToRetry.push({ stage: 'firmographics', workflow_id: 'Hl9aGZsO2GRt4eWGIkvxs', reason: 'Have domain, retry for firmographics' });\n}\n\n// If we have linkedin_url but no owner details, retry owner research\nif ((context.linkedin_url || context.owner_linkedin) && !checkValue('owner_name')) {\n  stagesToRetry.push({ stage: 'owner_discovery', workflow_id: 'LkcBjvdlGqBOYSdP', reason: 'Have LinkedIn, retry for owner details' });\n}\n\nreturn [{\n  json: {\n    // Original input preserved\n    ...input,\n    \n    // Assessment results\n    phase: 'assessment',\n    confidence_score: Math.round(confidenceScore * 100) / 100,\n    key_fields_found: keyFieldsFound,\n    found_fields: foundFields,\n    missing_fields: missingFields,\n    \n    // Exit decision\n    should_exit: shouldExit,\n    exit_reason: meetsConfidence ? 'confidence_threshold' : meetsKeyFields ? 'key_fields_found' : null,\n    \n    // Retry candidates\n    stages_to_retry: stagesToRetry,\n    has_retries: stagesToRetry.length > 0 && !shouldExit,\n    \n    // Thresholds used\n    thresholds: {\n      confidence: CONFIDENCE_THRESHOLD,\n      key_fields: KEY_FIELDS_THRESHOLD\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 0],
      "id": "phase-2-assessment",
      "name": "ğŸ“Š Phase 2: Assessment"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "has-retries",
              "leftValue": "={{ $json.has_retries }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [2240, 0],
      "id": "check-retries",
      "name": "ğŸ”€ Has Retries?"
    },
    {
      "parameters": {
        "jsCode": "// Execute retries for stages that could benefit from more context\nconst data = $json;\nconst retries = data.stages_to_retry || [];\n\n// We'll pass the retry info forward - the actual retries happen in parallel below\nreturn [{\n  json: {\n    ...data,\n    retry_count: retries.length,\n    retrying: retries.map(r => r.stage)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2480, 80],
      "id": "prep-retries",
      "name": "âš™ï¸ Prep Retries"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "4YgfhwtJDdVoBaQu",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "airtable_id": "={{ $json.airtable_id }}",
            "company_name": "={{ $json.company_name }}",
            "location": "={{ $json.location }}",
            "city": "={{ $json.city }}",
            "state": "={{ $json.state }}",
            "domain": "={{ $json.resolved_domain }}",
            "search_domain": "={{ $json.resolved_domain }}",
            "phone": "={{ $json.phone }}",
            "timestamp": "={{ new Date().toISOString() }}",
            "enrichment_id": "={{ $json.enrichment_id }}",
            "research_run_id": "={{ $json.research_run_id }}",
            "company_id": "={{ $json.company_id }}",
            "owner_name": "={{ $json.found_fields.includes('owner_name') ? 'RETRY_WITH_OWNER' : '' }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [2720, 0],
      "id": "retry-hunter",
      "name": "ğŸ”„ Retry: Hunter.io",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "LkcBjvdlGqBOYSdP",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "company_name": "={{ $('âš™ï¸ Prep Retries').item.json.company_name }}",
            "location": "={{ $('âš™ï¸ Prep Retries').item.json.location }}",
            "enrichment_id": "={{ $('âš™ï¸ Prep Retries').item.json.enrichment_id }}",
            "research_run_id": "={{ $('âš™ï¸ Prep Retries').item.json.research_run_id }}",
            "company_id": "={{ $('âš™ï¸ Prep Retries').item.json.company_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [2720, 160],
      "id": "retry-owner",
      "name": "ğŸ”„ Retry: Owner Research",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [2960, 80],
      "id": "merge-retries",
      "name": "ğŸ¤ Merge Retries"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "A4-U5nCoP9WMSikDE3qdi",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "company_id": "={{ $('âš™ï¸ Prep Retries').item.json.company_id }}",
            "research_run_id": "={{ $('âš™ï¸ Prep Retries').item.json.research_run_id }}"
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [3200, 80],
      "id": "retry-context-update",
      "name": "ğŸ§  Retry: Context Update",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [3440, 0],
      "id": "merge-final",
      "name": "ğŸ¤ Merge Final"
    },
    {
      "parameters": {
        "jsCode": "// Build final summary\nconst assessmentData = $('ğŸ“Š Phase 2: Assessment').first().json;\nconst input = $('âš™ï¸ Process Stage 0').first().json;\n\nreturn [{\n  json: {\n    status: 'completed',\n    research_run_id: input.research_run_id,\n    company_id: input.company_id,\n    company_name: input.company_name,\n    domain: input.resolved_domain,\n    \n    // Scores\n    confidence_score: assessmentData.confidence_score,\n    key_fields_found: assessmentData.key_fields_found,\n    exit_reason: assessmentData.exit_reason || 'pipeline_complete',\n    \n    // Fields\n    found_fields: assessmentData.found_fields,\n    missing_fields: assessmentData.missing_fields,\n    \n    // Retries\n    retries_attempted: assessmentData.has_retries || false,\n    stages_retried: assessmentData.retrying || [],\n    \n    // Stages run\n    stages_executed: [\n      'Stage 0: Smart Entry Router',\n      'Stage 1: Firecrawl Website',\n      'Stage 2a: Contact Form Hunter',\n      'Stage 2b: Hunter.io',\n      'Stage 3: Firmographics (Apollo)',\n      'Stage 4a: Headhunter Agent',\n      'Stage 4b: Owner Research',\n      'Stage 5a: Intel Analyst',\n      'Stage 5b: Job Board Hunter',\n      'Stage 5c: Career Page Analyzer',\n      'Stage 6: Apify Reviews',\n      'Stage 7: Context Updater'\n    ],\n    \n    completed_at: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3680, 0],
      "id": "build-summary",
      "name": "ğŸ“¤ Build Final Summary"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE enrichment_loop_runs SET status = 'completed', current_phase = 'completed', confidence_score = $2, key_fields_found = $3, exit_reason = $4, completed_at = NOW() WHERE research_run_id = $1;",
        "options": {
          "queryReplacement": "={{ [$json.research_run_id, $json.confidence_score, $json.key_fields_found, $json.exit_reason] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [3920, 0],
      "id": "mark-complete",
      "name": "ğŸ—„ï¸ Mark Complete",
      "credentials": {
        "postgres": {
          "id": "xogKD739Qe4gqWBU",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// No domain found - skip enrichment\nconst input = $json;\n\nreturn [{\n  json: {\n    status: 'skipped',\n    reason: 'no_domain_found',\n    research_run_id: input.research_run_id,\n    company_id: input.company_id,\n    company_name: input.company_name,\n    routing_path: input.routing_path,\n    skipped_at: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-400, 240],
      "id": "no-domain",
      "name": "âš ï¸ No Domain - Skip"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE enrichment_loop_runs SET status = 'skipped', exit_reason = 'no_domain_found', completed_at = NOW() WHERE research_run_id = $1;",
        "options": {
          "queryReplacement": "={{ [$json.research_run_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [-160, 240],
      "id": "mark-skipped",
      "name": "ğŸ—„ï¸ Mark Skipped",
      "credentials": {
        "postgres": {
          "id": "xogKD739Qe4gqWBU",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [[{"node": "ğŸ§± Normalize Record", "type": "main", "index": 0}]]
    },
    "When clicking 'Execute workflow'": {
      "main": [[{"node": "ğŸ” Search Airtable Records", "type": "main", "index": 0}]]
    },
    "ğŸ” Search Airtable Records": {
      "main": [[{"node": "ğŸ§± Normalize Record", "type": "main", "index": 0}]]
    },
    "ğŸ§± Normalize Record": {
      "main": [[{"node": "ğŸ—„ï¸ Register Run", "type": "main", "index": 0}]]
    },
    "ğŸ—„ï¸ Register Run": {
      "main": [[{"node": "ğŸš¦ Stage 0: Smart Entry Router", "type": "main", "index": 0}]]
    },
    "ğŸš¦ Stage 0: Smart Entry Router": {
      "main": [[{"node": "âš™ï¸ Process Stage 0", "type": "main", "index": 0}]]
    },
    "âš™ï¸ Process Stage 0": {
      "main": [[{"node": "ğŸ”€ Has Domain?", "type": "main", "index": 0}]]
    },
    "ğŸ”€ Has Domain?": {
      "main": [
        [{"node": "ğŸ”¥ Stage 1: Firecrawl Website", "type": "main", "index": 0}],
        [{"node": "âš ï¸ No Domain - Skip", "type": "main", "index": 0}]
      ]
    },
    "ğŸ”¥ Stage 1: Firecrawl Website": {
      "main": [[
        {"node": "ğŸ“§ Stage 2a: Contact Form Hunter", "type": "main", "index": 0},
        {"node": "ğŸ“§ Stage 2b: Hunter.io", "type": "main", "index": 0}
      ]]
    },
    "ğŸ“§ Stage 2a: Contact Form Hunter": {
      "main": [[{"node": "ğŸ¤ Merge Stage 2", "type": "main", "index": 0}]]
    },
    "ğŸ“§ Stage 2b: Hunter.io": {
      "main": [[{"node": "ğŸ¤ Merge Stage 2", "type": "main", "index": 1}]]
    },
    "ğŸ¤ Merge Stage 2": {
      "main": [[{"node": "ğŸ“Š Stage 3: Firmographics (Apollo)", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Stage 3: Firmographics (Apollo)": {
      "main": [[
        {"node": "ğŸ‘¤ Stage 4a: Headhunter Agent", "type": "main", "index": 0},
        {"node": "ğŸ‘¤ Stage 4b: Owner Research", "type": "main", "index": 0}
      ]]
    },
    "ğŸ‘¤ Stage 4a: Headhunter Agent": {
      "main": [[{"node": "ğŸ¤ Merge Stage 4", "type": "main", "index": 0}]]
    },
    "ğŸ‘¤ Stage 4b: Owner Research": {
      "main": [[{"node": "ğŸ¤ Merge Stage 4", "type": "main", "index": 1}]]
    },
    "ğŸ¤ Merge Stage 4": {
      "main": [[
        {"node": "ğŸ•µï¸ Stage 5a: Intel Analyst", "type": "main", "index": 0},
        {"node": "ğŸ’¼ Stage 5b: Job Board Hunter", "type": "main", "index": 0},
        {"node": "ğŸ“„ Stage 5c: Career Page Analyzer", "type": "main", "index": 0}
      ]]
    },
    "ğŸ•µï¸ Stage 5a: Intel Analyst": {
      "main": [[{"node": "ğŸ¤ Merge Stage 5", "type": "main", "index": 0}]]
    },
    "ğŸ’¼ Stage 5b: Job Board Hunter": {
      "main": [[{"node": "ğŸ¤ Merge Stage 5", "type": "main", "index": 1}]]
    },
    "ğŸ“„ Stage 5c: Career Page Analyzer": {
      "main": [[{"node": "ğŸ¤ Merge Stage 5", "type": "main", "index": 2}]]
    },
    "ğŸ¤ Merge Stage 5": {
      "main": [[{"node": "â­ Stage 6: Apify Reviews", "type": "main", "index": 0}]]
    },
    "â­ Stage 6: Apify Reviews": {
      "main": [[{"node": "ğŸ§  Stage 7: Context Updater", "type": "main", "index": 0}]]
    },
    "ğŸ§  Stage 7: Context Updater": {
      "main": [[{"node": "ğŸ“Š Phase 2: Assessment", "type": "main", "index": 0}]]
    },
    "ğŸ“Š Phase 2: Assessment": {
      "main": [[{"node": "ğŸ”€ Has Retries?", "type": "main", "index": 0}]]
    },
    "ğŸ”€ Has Retries?": {
      "main": [
        [{"node": "âš™ï¸ Prep Retries", "type": "main", "index": 0}],
        [{"node": "ğŸ¤ Merge Final", "type": "main", "index": 0}]
      ]
    },
    "âš™ï¸ Prep Retries": {
      "main": [[
        {"node": "ğŸ”„ Retry: Hunter.io", "type": "main", "index": 0},
        {"node": "ğŸ”„ Retry: Owner Research", "type": "main", "index": 0}
      ]]
    },
    "ğŸ”„ Retry: Hunter.io": {
      "main": [[{"node": "ğŸ¤ Merge Retries", "type": "main", "index": 0}]]
    },
    "ğŸ”„ Retry: Owner Research": {
      "main": [[{"node": "ğŸ¤ Merge Retries", "type": "main", "index": 1}]]
    },
    "ğŸ¤ Merge Retries": {
      "main": [[{"node": "ğŸ§  Retry: Context Update", "type": "main", "index": 0}]]
    },
    "ğŸ§  Retry: Context Update": {
      "main": [[{"node": "ğŸ¤ Merge Final", "type": "main", "index": 1}]]
    },
    "ğŸ¤ Merge Final": {
      "main": [[{"node": "ğŸ“¤ Build Final Summary", "type": "main", "index": 0}]]
    },
    "ğŸ“¤ Build Final Summary": {
      "main": [[{"node": "ğŸ—„ï¸ Mark Complete", "type": "main", "index": 0}]]
    },
    "âš ï¸ No Domain - Skip": {
      "main": [[{"node": "ğŸ—„ï¸ Mark Skipped", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "description": "Lead Enrichment Orchestrator v5 - All 12 sub-workflows + Phase 2 assessment and retry logic",
    "category": "lead_enrichment",
    "version": "5.0"
  }
}
